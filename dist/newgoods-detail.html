<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="Generator" content="mizanwang.com "/>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="600">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
    <link rel="stylesheet" href="css/main.css?v=32"/>
    <link rel="stylesheet" href="css/swiper.min.css?v=7"/>
    <title></title>
    <meta name="Keywords" content=""/>
    <meta name="Description" content=""/>
</head>
<body style="font-size: 20px" >
<div class="loading" style="display: none;position: fixed;z-index: 99;background: rgba(255, 255, 255, 0.84);top: 0%;bottom: 0%;left: 0%;right: 0%;text-align: center;padding-top: 28%;font-size: 16px;">loading...</div>

<div class="page" >
    <div class="content">
        <div class="downloadApp" style="display: none">
            <div class="downloadLeft">
                <img src="images/download.png" alt="">
                <div class="colflex">
                    <div class="title">海外购APP</div>
                    <div class="subtitle">有态度的海购分享社区</div>
                </div>
            </div>
            <a class="btn" href="http://a.app.qq.com/o/simple.jsp?pkgname=com.mizanwang.app">立即下载</a>
        </div>
        <div id="goods-detail" class="hasToolbar">
            <div id="goods_news">
                <div class="mm-upthedetailimg">
                    <div class="swiper-container detailPic-swiper">
                        <div class="swiper-wrapper">
                            <!--细节图-->
                        </div>
                        <div class="cart-unit"></div>
                        <div class="in_stock"></div>
                        <div class="detailPic-swiper-index">0/0</div>
                    </div>
                    <div class="detail-images swiper-container center">
                        <ul class="swiper-wrapper">
                            <!--类型图-->
                        </ul>
                    </div>
                </div>
                <div class="mm-hastest" style="display: none">
                    <span>荔赞严选，团队亲测，每月质检</span>
                    <span class="mm-arrow-right"></span>
                </div>

                <div class="detail-name container bd0">
                    <div class="name-title deepergray"><span id="discount" style="color: #ff0101;"></span><span id="nametitle" data-goodsid=""></span></div>
                    <p class="name-price"><span id="nameprice" class=" colorred"></span> <span class="mm-freetax" style="display: none">包邮包税</span></p>
                    <p class="grayfont refer" style="padding: 0 12px"><span class="name-referprice" style="display: none"><span id="form_refer">国内参考价：</span><span class="line-throungh" id="namereferprice"></span></span><span class="brbr" style="display: none">&nbsp; | &nbsp;</span><span class="unitpromot" style="display: none">单件<span class="unitprice"></span>元</span></p>
                    <div class="mm-tag grayfont onepicel">
                    </div>
                    <span class="cart_number_least" style="display: none"></span>
                </div>
            </div>
            <!--一次加载-->
            <div id="onecTime">

            </div>

            <!--<div id="Adivce-carriage" class="adivce-carriage" style="display: none;">
                <div class="mm-advice-title">
                    <p class="mm-advice-hrline"></p>
                    <span>商品推荐</span>
                </div>
                <div class="mm-adivce-carriage" id="flag" style="position: relative">
                    <style type="text/css">
                        .infinite-scroll-preloader {
                            margin-top:-20px;
                        }
                    </style>
                    <div class="infinite-scroll infinite-scroll-bottom" data-distance="50">
                        <div class="list-block">
                            <div class="list-container">

                            </div>
                        </div>
                    </div>

                </div>
            </div>-->

            <div class="detail-buy rowflex before-scale">
                <a class="buy-btn btn-scar" href="#">
                    <span class="buytips buytips-up">成功加入购物车</span>
                    <span class="tag-num" style="display:none">0</span>
                    购物车
                </a>
                <a class="buy-btn btn-shoppingCart">加入购物车</a>
                <a class="buy-btn btn-collect" toggle-class="active" href="#">收藏</a>

            </div>
            <input type="text" style="display: none" name="token" id="token" value="" />
            <input type="text" style="display: none" name="cart_number_least" id="cart_number_least" value="" />
        </div>
        <div class="totop"></div>
    </div>
</div>

<div id="buyPageInner">
    <div class="buyPage-mark"></div>
    <div class="colflex">
        <div class="flextop">
            <div class="goods-messages rowflex">
                <span class="btn-grayBar"></span>
                <img id="goods_buy_small_image" src="" alt="" data-goods_id="">

                <div class="messages-wrap">
                    <p class="f18" style="margin-bottom: 15px;margin-top: 10px;">¥ <span id="promote_price">0</span>&nbsp;<span class="grayfont line-throungh">¥<span id="market_price">0</span></span></p>
                    <p class="f13 grayfont" style="margin-bottom: 15px;">重量<span id="mall_weight">0.0</span>kg&nbsp;&nbsp;&nbsp;&nbsp;运费¥<span id="transit_fee"></span>0</p>
                    <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">已选<span id="had_selected_attr_values" ></span></p>
                </div>
            </div>
        </div>
        <div class="flexcenter">
            <div class="goods-tips">
                <span>温馨提示：</span>
                以下信息均由海外官网提供，仅供参考。
            </div>
            <div class="goods-selection">
                <div class="selection-items">
                    <div class="selection-title">购买数量</div>
                    <ul class="selection-num">
                        <li class="num-subtract">-</li>
                        <li class="num-bar"></li>
                        <li class="number">0</li>
                        <li class="num-bar"></li>
                        <li class="num-add">+</li>
                    </ul>
                </div>
                <div id="add_attributeBtn"></div>

            </div>
        </div>
        <div class="flexbottom">
            <!--<div class="goods-selection">
                <div class="selection-items">
                    <div class="selection-title">目前有货</div>
                </div>
            </div>-->
            <a class="items-btnConfirm" href="#">加入购物车</a>
        </div>
    </div>
</div>
<script src="js/zepto.min.js"></script>
<script src="js/swiper.min.js"></script>
<script src="js/ponto.js?v=4"></script>
<script src="js/jquery.js"></script>
<script>
    var GlobalsaveToken /*= "9468e749e9bc12ea85ab8dd5799aac43"*/;
    $(document).ready(function(){
            function getQueryString(name) {
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                var r = window.location.search.substr(1).match(reg);
                if (r != null) return unescape(r[2]); return null;
            }
            var Val_id = getQueryString("id");
            var deviceid = getQueryString("deviceid");
            var open = getQueryString("open");

            var buygoosID;
            /*if(deviceid == null){
                deviceid = null;
                $(".downloadApp").show();
            }else {
                $(".downloadApp").hide();
            }*/
            if(open == null){
                $(".downloadApp").hide();
                Ponto.invoke(
                        "Messaging",
                        "getToken",
                        {userLogin:false},
                        function (data) {
                            //alert(String(data)); JSON.stringify
                            //alert(data);
                            //alert(typeof(data));
                            
                            if( typeof(data) != 'string' )
                            {
																GlobalsaveToken = "21";
                            }else
                            {
                            		if(  data.indexOf("devId") > 0 )
                            		{
                            				deviceid = JSON.parse(data).devId;
						                        $("#token").val(JSON.parse(data).token);
						                        GlobalsaveToken = JSON.parse(data).token;                             				
                            		}else
                            		{
						                            $("#token").val(data);
						                            GlobalsaveToken = data; 	                            				
                            		}
		                         }
                            //alert(GlobalsaveToken);
                            $.ajax({
                                type:"POST",
                                url:"../goods_interface.php",
                                async:true,
                                data:{
                                    intertype:"100",
                                    id:Val_id,
                                    deviceid:deviceid,
                                    token:GlobalsaveToken,
                                },
                                datatype: "jsonp",//"xml", "html", "script", "json", "jsonp", "text".
                                beforeSend:function(){
                                    $(".loading").show();
                                },
                                success:function(data){
                                    $(".loading").hide();
                                    console.log(JSON.parse(data));
                                    coloursgoods(JSON.parse(data).goods);
                                    addOnce(JSON.parse(data).goods);
                                },
                                complete: function(XMLHttpRequest, textStatus){
                                    //alert("over");
                                    if( XMLHttpRequest.responseText == "ok" ) {}
                                    else if(XMLHttpRequest.responseText == "errlogin" ) {}
                                    else if(XMLHttpRequest.responseText == "errgoods" ) {}
                                },
                                error: function(){
                                    //请求出错处理
                                    Ponto.invoke(
                                            "Messaging",
                                            "toast",
                                            {"title":'网络断了，请稍后再试'},
                                            null,
                                            null);
                                }
                            });
                        }
                );
            }else{
                $(".downloadApp").show();
                $.ajax({
                    type:"POST",
                    url:"../goods_interface.php",
                    async:true,
                    data:{
                        intertype:"100",
                        id:Val_id,
                        deviceid:deviceid
                    },
                    datatype: "jsonp",//"xml", "html", "script", "json", "jsonp", "text".
                    beforeSend:function(){
                        $(".loading").show();
                    },
                    success:function(data){
                        $(".loading").hide();
                        console.log(JSON.parse(data));
                        coloursgoods(JSON.parse(data).goods);
                        addOnce(JSON.parse(data).goods);
                    }
                });
            }

            var chooseIDinfo;
            var onCarGoodsList = new Object(); //已经加入购物车的物品;
            function coloursgoods(goodsNew){
                //alert(goodsNew.goods_id);
                var html = '',first ='';
                var lowest;
                var lowest_index;
                lowest = eval(goodsNew.lowest_goods_info_id);
                chooseIDinfo = goodsNew.lowest_goods_info_id;
                var smallimg; //分享的小图
                if(lowest>0){
                    //有goods_child_info
                    smallimg = goodsNew.goods_child_info[0].buy_small_img;
                    if(goodsNew.goods_child_info.length == 1){
                        $(".detail-images ").hide();
                    }
                    for (var i =0;i<goodsNew.goods_child_info.length;i++){
                        if(eval(goodsNew.goods_child_info[i].goods_info_id) == lowest){
                            if(goodsNew.goods_child_info[i].gallery_list){
                                for(var u =0;u<goodsNew.goods_child_info[i].gallery_list.length;u++){
                                    if(goodsNew.goods_child_info[i].gallery_list[u].is_home == 1){
                                        first ='<div class=swiper-slide><img src="'+goodsNew.goods_child_info[i].gallery_list[u].thumb_url+'" alt="'+goodsNew.goods_child_info[i].gallery_list[u].thumb_desc+'"></div>'
                                    }else{
                                        html +='<div class=swiper-slide><img src="'+goodsNew.goods_child_info[i].gallery_list[u].thumb_url+'" alt="'+goodsNew.goods_child_info[i].gallery_list[u].thumb_desc+'"></div>'
                                    }
                                    html +='';
                                }
                                lowest_index = i;
                                html = first+html;
                            }
                            lowest_index = i;
                        }else{
                            lowest_index = 0;
                        }
                    }
                    $(".detailPic-swiper .swiper-wrapper").append(html);
                    var typehtml = ''; //缩略图
                    if(goodsNew.goods_child_info.length >6){
                        $(".detail-images ").removeClass("center");
                    }
                    for(var i =0;i<goodsNew.goods_child_info.length;i++){
                        typehtml += '<li class="swiper-slide" data-type="'+[i]+'" data-goodinfoid="'+goodsNew.goods_child_info[i].goods_info_id+'"><img src="'+goodsNew.goods_child_info[i].buy_small_img+'" alt=""></li>';
                    }
                    $(".detail-images .swiper-wrapper").append(typehtml);
                    var mySwiper1 = new Swiper('.detail-images',{
                        slidesPerView : 'auto',
                        touchRatio : 0.5,
                        shortSwipes : true,
                        loop : false
                    });
                    $(".detail-images .swiper-wrapper li").eq(lowest_index).addClass("pink-border");
                    var piclenght = goodsNew.goods_child_info[lowest_index].gallery_list.length;
                    var html ='';
                    for(var i=0;i< piclenght;i++){
                        html += '<div class="swiper-slide"><a href="#"><img src="'+goodsNew.goods_child_info[lowest_index].gallery_list[i].thumb_url+'" alt=""></a></div>';
                    }
                    $(".detailPic-swiper .swiper-wrapper").empty().append(html);
                    //内容

                    $("#nametitle").html(goodsNew.name);
                    $("#nametitle").data("goods_id",goodsNew.goods_id);
                    $("#nameprice").html('¥ '+goodsNew.goods_child_info[lowest_index].target_promote_price);
                    if(goodsNew.goods_child_info[lowest_index].target_market_price){
                        $(".name-referprice").show();
                        $("#namereferprice").html('¥ '+goodsNew.goods_child_info[lowest_index].target_market_price);
                    }
                    if(goodsNew.goods_child_info[lowest_index].target_discount){
                        $("#discount").html(goodsNew.goods_child_info[lowest_index].target_discount+'折');
                    }
                    if(goodsNew.goods_source_list){
                        var tag1html = '';
                        for (var i =0;i<goodsNew.goods_source_list.length;i++){
                            tag1html +='<span class="g" style="background: url(&quot;'+goodsNew.goods_source_list[i].icon+'&quot;) no-repeat;background-size: 14px 14px;">'+goodsNew.goods_source_list[i].name+'</span>';
                        }
                        $(".mm-tag").append(tag1html);
                    }
                    if(goodsNew.cart_number_least){
                        $(".cart_number_least").html(goodsNew.cart_number_least);
                    }
                    var CliChooseType = '';
                    $(".detail-images ul li").each(function(index){
                        $(this).click(function(){
                            $(".detail-images ul li").removeClass("pink-border");
                            $(this).addClass("pink-border");
                            var goodinfoid = $(this).data("goodinfoid");
                            //console.log(goodinfoid);
                            CliChooseType = index;
                            chooseIDinfo = eval($(this).data("goodinfoid"));
                            console.log("点击的是哪个款式："+index+"infoid:"+$(this).data("goodinfoid"));
                            var piclenght = goodsNew.goods_child_info[index].gallery_list.length;
                            var html ='';
                            for(var i=0;i< piclenght;i++){
                                html += '<div class="swiper-slide"><a href="#"><img src="'+goodsNew.goods_child_info[index].gallery_list[i].thumb_url+'" alt=""></a></div>';
                            }
                            $(".detailPic-swiper .swiper-wrapper").empty().append(html);
                            //$(".detailPic-swiper .swiper-wrapper").css("transform"," translate3d(0px, 0px, 0px)");
                            $('.detailPic-swiper').each(function() {
                                var $this = $(this);
                                var $pager = $this.find('.detailPic-swiper-index');
                                $(".detailPic-swiper .swiper-wrapper .swiper-slide").size();
                                new Swiper($this, {
                                    loop: true,
                                    observer:true,
                                    observeParents:true,
                                    pagination: $this.find('.swiper-pagination'),
                                    onSlideChangeEnd: function(swiper) {
                                        $pager.html((parseInt(swiper.slides[swiper.activeIndex]
                                                        .getAttribute('data-swiper-slide-index')) + 1) +
                                                '/' + ( $(".detailPic-swiper .swiper-wrapper .swiper-slide").size()- 2));
                                    }
                                });
                            });

                            $("#nameprice").html('￥'+goodsNew.goods_child_info[index].target_promote_price);
                            if(goodsNew.goods_child_info[index].target_discount){
                                $("#discount").html(goodsNew.goods_child_info[index].target_discount+'折');
                            }
                            if(goodsNew.goods_child_info[index].target_market_price){
                                $(".name-referprice").show();
                                $("#namereferprice").html('￥'+goodsNew.goods_child_info[index].target_market_price);
                            }

                        });
                    });
                }else{
                    $(".detail-images ").hide();
                    //没有goods_child_info
                    smallimg = goodsNew.buy_small_img;
                    if(goodsNew.gallery_list){
                        for (var i =0;i<goodsNew.gallery_list.length;i++){
                            html +='<div class=swiper-slide><a href="#"><img src="'+goodsNew.gallery_list[i].thumb_url+'" alt="'+goodsNew.gallery_list[i].thumb_desc+'"></a></div>'
                        }
                        $(".detailPic-swiper .swiper-wrapper").append(html);
                    }

                    if(goodsNew.target_discount){
                        $("#discount").html(goodsNew.target_discount+'折');
                    }
                    $("#nametitle").html(goodsNew.name);

                    $("#nameprice").html('¥ '+goodsNew.target_promote_price);
                    if(goodsNew.target_market_price){
                        $(".name-referprice").show();
                        $("#namereferprice").html('¥ '+goodsNew.target_market_price);
                    }
                    if(goodsNew.goods_source_list){
                        var tag1html = '';
                        for (var i =0;i<goodsNew.goods_source_list.length;i++){
                            tag1html +='<span class="g" style="background: url(&quot;'+goodsNew.goods_source_list[i].icon+'&quot;) no-repeat;background-size: 14px 14px;">'+goodsNew.goods_source_list[i].name+'</span>';
                        }
                        $(".mm-tag").append(tag1html);
                    }
                }
                $('.detailPic-swiper').each(function() {
                    var $this = $(this);
                    var $pager = $this.find('.detailPic-swiper-index');
                    $(".detailPic-swiper .swiper-wrapper .swiper-slide").size();
                    new Swiper($this, {
                        loop: true,
                        observer:true,
                        observeParents:true,
                        pagination: $this.find('.swiper-pagination'),
                        onSlideChangeEnd: function(swiper) {
                            $pager.html((parseInt(swiper.slides[swiper.activeIndex]
                                            .getAttribute('data-swiper-slide-index')) + 1) +
                                    '/' + ( $(".detailPic-swiper .swiper-wrapper .swiper-slide").size()- 2));
                        }
                    });
                });//滑动
                //分享功能
                 var subtitle = goodsNew.one_p2 ? goodsNew.one_p2 : goodsNew.name;
                 /*console.log(goodsNew.goods_share_url);
                 console.log(goodsNew.name);
                 console.log(subtitle);
                 console.log(smallimg);*/
                 Ponto.invoke(
                 "Messaging",
                 "share2",
                 {url: goodsNew.goods_share_url, title: goodsNew.name, subTitle:subtitle, sImageUrl:smallimg },
                 null,
                 null
                 );
            }
            function addOnce(obj){
                console.log("add");
                $("title").html(obj.name);
                if(obj.is_collection == 1){
                    btnCollect.addClass("active");
                }else{
                    btnCollect.removeClass("active");
                }
                var html = '';
                if(obj.one_p1){
                    html+='<div class="pointComment container bd0 mbottom"><div class="mizan-points"><div class="mm-commen-title"><p class="mm-hrline onepicel"></p><span>'+obj.one_p1+'</span></div><p class="deepgray">'+obj.one_p2+'</p></div></div>';
                }else {
                }
                if(obj.one_detail_p){
                    html +='<div class="goods-detail container bd0 mbottom"><div class="mm-commen-title"><p class="mm-hrline onepicel"></p><span>商品详情</span></div><div class="goods-detail-info deepgray"><div class="detail_p" style="text-align:center;">';
                    html +=obj.one_detail_p;
                    html +='</div></div></div>';
                }else{
                    html +='';
                }
                if(obj.brand_desc){
                    html +='<div class="goods-detail container bd0 mbottom"><div class=goods-detail-info>';
                    html +='<div style="text-align: center;margin-top: 8px;"><img src="'+obj.brand_logo+'" style="height: 60px;" onerror="document.getElementById(\'pp\').style.display=\'block\';this.parentNode.removeChild(this);"><div class="mm-commen-title" id="pp" style="display: none;"><p class="mm-hrline onepicel"></p><span>品牌信息</span></div></div><div class="deepgray">'+obj.brand_desc+'</div>';
                    html+='</div></div></div>';
                }
                if(obj.is_mizan_selected == 1){
                    $(".mm-hastest").show();
                }else {
                    $(".mm-hastest").hide();
                }
                if(obj.is_tax_package == 1){
                    $(".mm-freetax").show();
                }else {
                    $(".mm-freetax").hide();
                }
                if(obj.goods_service_commitment){
                    html +='<div class="goods-detail container bd0 mbottom"><div class="mm-commen-title"><p class="mm-hrline onepicel"></p><span>服务承诺</span></div><div class=goods-detail-info>';
                    for (var i =0;i<obj.goods_service_commitment.length;i++){
                        html +='<div class="promit promit1" style="background: url(&quot;'+obj.goods_service_commitment[i].icon+'&quot;) no-repeat top center;background-size: 40px 40px;"><p>'+obj.goods_service_commitment[i].name+'</p></div>';
                    }
                    html+='</div></div>';
                }else{
                    html +='';
                }
                if(obj.shopping_process){
                    html +='<div class="detail-process container bd0 mbottom">';
                    if(obj.shopping_process.shopping_process){
                        html +='<div class=mm-commen-title><p class="mm-hrline onepicel"></p><span>物流流程</span></div><img src="'+obj.shopping_process.shopping_process+'" class=mbottom>';
                    }
                    if(obj.shopping_process.before_shopping){
                        html +='<div class=mm-commen-title><p class="mm-hrline onepicel"></p><span>买前须知</span></div><ol class=hide>';
                        for (var i =0;i<obj.shopping_process.before_shopping.length;i++){
                            html+='<li>'+obj.shopping_process.before_shopping[i]+'</li>';
                        }
                        html +='</ol><a class=detail-process-more href="#">阅读全文</a>';
                    }
                    html +='</div>';
                }
                $('#onecTime').append(html);
                if(obj.cart_goods_unit && obj.cart_number_least >1){
                    $(".cart-unit").html('<p style="color: #f00425;">'+obj.cart_number_least+'</p><p>'+obj.cart_goods_unit+'</p>').show();
                    $(".unitprice").html(obj.target_unit_promote_price);
                    $(".unitpromot").show();
                    if(obj.target_market_price){
                        $(".brbr").show();
                    }
                }
                var goodsnum =0;
                if(obj.goods_number_list){
                    onCarGoodsList = obj.goods_number_list;
                    for(var i =0;i<obj.goods_number_list.length;i++){
                        goodsnum += eval(obj.goods_number_list[i].goods_num);
                    }
                    $('.tag-num').html(goodsnum).show();
                }
                //alert(obj.goods_id);

                /*显示隐藏*/
                $('.detail-process-more').click(function () {
                    var ol = $('.detail-process ol'),
                            arrow = $('.detail-process .detail-process-more'),
                            height = 0;
                    if (ol.hasClass('hide')) {
                        ol.children().each(function () {
                            console.log($(this).height());
                            height += $(this).height();
                        });
                        ol.removeClass('hide').css('height', height);
                        arrow.addClass('up');
                    } else {
                        ol.addClass('hide').removeAttr('style');
                        arrow.removeClass('up');
                    }
                    return false;
                });

                var lowest;
                var btncartshop = $('.btn-shoppingCart');
                lowest = eval(obj.lowest_goods_info_id);
                if(obj.is_on_sale == 1){
                    if(obj.is_in_stock == 0){ //抢光
                        btncartshop.css({'background':"#ccc",'border': '1px solid #c4c5c6'});
                        btncartshop.html("商品已抢光");
                        $(".in_stock").show();
                    }else{
                        var canbug = false;
                        btncartshop.click(function () {
                            buygoosID = obj.goods_id;
                            //alert(buygoosID);
                            //alert(lowest);
                            if(lowest>0){
                                console.log("进入购物车");
                                //alert("进入购物车");
                                if(GlobalsaveToken == null){
                                    Ponto.invoke(
                                            "Messaging",
                                            "login",
                                            {},
                                            null,
                                            null);
                                }else{
                                    $.ajax({
                                        type: "POST",
                                        url: "../goods_interface.php",
                                        data:{
                                            "intertype":102,
                                            "id":Val_id,
                                            "deviceid":deviceid,//"867628026358119"
                                            "token": GlobalsaveToken,//"9468e749e9bc12ea85ab8dd5799aac43"
                                            /*"deviceid":"867628026358119",
                                             "token": "9468e749e9bc12ea85ab8dd5799aac43",*/
                                            "default_goods_info_id":chooseIDinfo
                                        },
                                        success: function(data){
                                            if(JSON.parse(data).code == 200){
                                                //alert(JSON.parse(data).goods);
                                                console.log(JSON.parse(data).goods);
                                                closureselect(JSON.parse(data).goods);
                                            }
                                            if(JSON.parse(data).code == 202){
                                                //token值不匹配
                                                Ponto.invoke(
                                                        "Messaging",
                                                        "toast",
                                                        {"title":JSON.parse(data).message},
                                                        null,
                                                        null);
                                                Ponto.invoke(
                                                        "Messaging",
                                                        "login",
                                                        {},
                                                        null,
                                                        null);
                                               /* Ponto.invoke(
                                                        "Messaging",
                                                        "getToken",
                                                        {userLogin:true},
                                                        function (token) {
                                                            $("#token").val(token);
                                                            GlobalsaveToken = token;
                                                        },
                                                        null);*/
                                            }else{
                                                Ponto.invoke(
                                                        "Messaging",
                                                        "toast",
                                                        {"title":JSON.parse(data).message},
                                                        null,
                                                        null);
                                            }
                                        },
                                        error: function(){
                                            //请求出错处理
                                            alert("请从APP端购买！")
                                            Ponto.invoke(
                                                    "Messaging",
                                                    "toast",
                                                    {"title":'网络断了，请稍后再试'},
                                                    null,
                                                    null);
                                        }
                                    });
                                    function closureselect(obj){
                                        Ponto.invoke(
                                                "Messaging",
                                                "refreshable",
                                                {isfresh:false},
                                                null,
                                                null);
                                        Ponto.invoke(
                                                "Messaging",
                                                "hideBackBtn",
                                                null,
                                                null,
                                                null);
                                        detail.hide();
                                        $('.number').html(1);
                                        buyPage.show();
                                        //加减数量
                                        $('.num-subtract').unbind("tap");
                                        $('.num-subtract').bind("tap",function(){
                                            var addnum = eval($(".cart_number_least").html());
                                            var inputnum = eval($('.number').html());
                                            goodsnum = inputnum - addnum;
                                            if (goodsnum <= 0) {
                                                goodsnum = 0;
                                            }
                                            $('.number').text(goodsnum);
                                        });
                                        $('.num-add').unbind("tap");
                                        $('.num-add').bind("tap",function(){
                                            var addnum = eval($(".cart_number_least").html());
                                            var inputnum = eval($('.number').html());
                                            goodsnum = inputnum + addnum;
                                            $('.number').text(goodsnum);
                                        });

                                        $("#add_attributeBtn").empty();
                                        for(var n=0;n<obj.length;n++) {
                                            var attributehtml = '<div class=selection-items><div class=selection-title>' + obj[n].attr_name + ':</div><ul class="selection-list" data-attrgroup="' + n + '" id="btn_attribute' + n + '">';
                                            for (var i = 0; i < obj[n].attr_value_info.length; i++) {
                                                var allowid = [];
                                                for (var m = 0; m < obj[n].attr_value_info[i].goods_info_list.length; m++) {
                                                    allowid.push(obj[n].attr_value_info[i].goods_info_list[m].goods_info_id)
                                                } //记录序列号
                                                attributehtml += '<li class="selection-valid" data-allowid="' + allowid + '" data-xuhao="' + i + '">' + obj[n].attr_value_info[i].attr_value + '</li>';
                                            }
                                            attributehtml += '</ul></div>';
                                            $("#add_attributeBtn").append(attributehtml);
                                        }
                                        var timearray = new Object(); //临时数组
                                        for(var nn=0; nn<$(".selection-list").size();nn++){
                                            $("#btn_attribute" + nn + " li").each(function (a) { //绑定点击事件
                                                $(this).unbind("click");
                                                $(this).bind("click", function () {
                                                    $(this).parent().children("li").removeClass("selection-active");
                                                    var groupindex = $(this).parent().data("attrgroup");
                                                    $(this).addClass("selection-active");
                                                    var allowdata = $(this).data("allowid");
                                                    var dataStrArr;
                                                    var dataIntArr = [];
                                                    if (typeof(allowdata) == "string") {
                                                        dataStrArr = allowdata.split(",");
                                                        dataStrArr.forEach(function (data) {
                                                            dataIntArr.push(+data);
                                                        });
                                                    } else {
                                                        dataStrArr = Number(allowdata);
                                                        dataIntArr.push(+dataStrArr);
                                                    }
                                                    //console.log("数组" + dataIntArr);
                                                    //console.log("click:" + a + "parent" + groupindex + "dataIntArr" + dataIntArr);
                                                    timearray.infoid = dataIntArr;
                                                    timearray.value = obj[groupindex].attr_value_info[a].goods_info_list;
                                                    var hadselect=[];
                                                    if(obj.length == 1){
                                                        for(var l = 0;l<$("#btn_attribute0 li").size();l++){
                                                            if($("#btn_attribute0 li").eq(l).hasClass("selection-active")){
                                                                console.log("其他的选中的是"+l);
                                                                hadselect =$("#btn_attribute0 li").eq(l).data("allowid");
                                                                thesame(timearray,hadselect);
                                                                function thesame(timearray,hadselect){
                                                                    var a;
                                                                    var g=[];
                                                                    if (typeof(hadselect) == "string")
                                                                    {
                                                                        a=hadselect.split(",");
                                                                        a.forEach(function(data){
                                                                            g.push(+data);
                                                                        });
                                                                    }else
                                                                    {
                                                                        a =Number(hadselect);
                                                                        g.push(+hadselect);
                                                                    }
                                                                    for(var s = 0;s < g.length;s++){
                                                                        console.log(g.length);
                                                                        for(var i =0; i<timearray.infoid.length ;i++){
                                                                            if(g[s] == timearray.infoid[i]){
                                                                                $("#promote_price").html(timearray.value[i].promote_price);
                                                                                $("#market_price").html(timearray.value[i].market_price);
                                                                                $("#mall_weight").html(timearray.value[i].mall_weight);
                                                                                $("#transit_fee").html(timearray.value[i].transit_fee);
                                                                                $("#goods_buy_small_image").attr("src", timearray.value[i].buy_small_img);
                                                                                $("#goods_buy_small_image").data("goodsid",timearray.value[i].goods_info_id);
                                                                            }
                                                                        }
                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }else{
                                                        for(var i =0;i<obj.length;i++){
                                                            if(i == groupindex){
                                                                //点击的那一行
                                                            }else {
                                                                for(var l = 0;l<$("#btn_attribute"+i+" li").size();l++){
                                                                    if($("#btn_attribute"+i+" li").eq(l).hasClass("selection-active")){
                                                                        console.log("其他的选中的是"+l);
                                                                        hadselect =$("#btn_attribute"+i+" li").eq(l).data("allowid");
                                                                        thesame(timearray,hadselect);
                                                                        function thesame(timearray,hadselect){
                                                                            var a;
                                                                            var g=[];
                                                                            if (typeof(hadselect) == "string")
                                                                            {
                                                                                a=hadselect.split(",");
                                                                                a.forEach(function(data){
                                                                                    g.push(+data);
                                                                                });
                                                                            }else
                                                                            {
                                                                                a =Number(hadselect);
                                                                                g.push(+hadselect);
                                                                            }
                                                                            for(var s = 0;s < g.length;s++){
                                                                                console.log(g.length);
                                                                                for(var i =0; i<timearray.infoid.length ;i++){
                                                                                    if(g[s] == timearray.infoid[i]){
                                                                                        $("#promote_price").html(timearray.value[i].promote_price);
                                                                                        $("#market_price").html(timearray.value[i].market_price);
                                                                                        $("#mall_weight").html(timearray.value[i].mall_weight);
                                                                                        $("#transit_fee").html(timearray.value[i].transit_fee);
                                                                                        $("#goods_buy_small_image").attr("src", timearray.value[i].buy_small_img);
                                                                                        $("#goods_buy_small_image").data("goodsid",timearray.value[i].goods_info_id);
                                                                                    }
                                                                                }
                                                                            }
                                                                        }

                                                                    }else{
                                                                        console.log("无选中其它的select项");
                                                                        var invalidindex ;
                                                                        for(var s = 0;s < $("#btn_attribute"+i+" li").size();s++){
                                                                            var notselectli = $("#btn_attribute"+i+" li").eq(s).data("allowid");
                                                                            var q;
                                                                            var wnotselectli=[];
                                                                            if (typeof(notselectli) == "string")
                                                                            {
                                                                                q=notselectli.split(",");
                                                                                q.forEach(function(data){
                                                                                    wnotselectli.push(+data);
                                                                                });
                                                                            }else
                                                                            {
                                                                                q =Number(notselectli);
                                                                                wnotselectli.push(+notselectli);
                                                                            }
                                                                            //console.log(wnotselectli);
                                                                            $("#btn_attribute"+i+" li").eq(s).removeClass("selection-invalid");
                                                                            Array.ExistsSameValues = function(a1, a2) {  //判断两个数组是否有相同的
                                                                                var exists = false;
                                                                                if(a1 instanceof Array && a2 instanceof Array)
                                                                                {
                                                                                    for (var i=0,iLen=a1.length; i<iLen; i++)
                                                                                    {
                                                                                        for (var j=0,jLen=a2.length; j<jLen; j++)
                                                                                        {
                                                                                            if (a1[i]===a2[j])
                                                                                            {
                                                                                                return true;
                                                                                            }
                                                                                        }
                                                                                    }
                                                                                }
                                                                                return exists;
                                                                            };
                                                                            if(Array.ExistsSameValues(dataIntArr, wnotselectli)){

                                                                            }else{
                                                                                if($("#btn_attribute"+i+" li").eq(s).hasClass("selection-active")){
                                                                                    $("#btn_attribute"+i+" li").eq(s).removeClass("selection-active");
                                                                                    $("#promote_price").html(timearray.value[0].promote_price);
                                                                                    $("#market_price").html(timearray.value[0].market_price);
                                                                                    $("#mall_weight").html(timearray.value[0].mall_weight);
                                                                                    $("#transit_fee").html(timearray.value[0].transit_fee);
                                                                                    $("#goods_buy_small_image").attr("src", timearray.value[0].buy_small_img);
                                                                                }
                                                                                $("#btn_attribute"+i+" li").eq(s).addClass("selection-invalid");
                                                                            }
                                                                        }

                                                                    }
                                                                }
                                                            }
                                                        }
                                                    }

                                                    var hasselect = ''; //已选中的文字内容
                                                    for (var i = 0; i < $(".selection-list").size(); i++) {
                                                        for (var e = 0; e < $("#btn_attribute" + i + " li").size(); e++) {
                                                            if ($("#btn_attribute" + i + " li").eq(e).hasClass("selection-active")) {
                                                                hasselect += '"' + $("#btn_attribute" + i + " li").eq(e).html() + '"';
                                                            }
                                                        }
                                                        $("#had_selected_attr_values").html(hasselect);
                                                    }
                                                });
                                            });
                                        }
                                        for(var n=0; n<$(".selection-list").size();n++){
                                            for (var s = 0; s < obj[n].attr_value_info.length; s++) { //默认点击选中的
                                                for (var p = 0; p < obj[n].attr_value_info[s].goods_info_list.length; p++) {
                                                    var obj_info_id = eval(obj[n].attr_value_info[s].goods_info_list[p].goods_info_id);
                                                    if (chooseIDinfo == obj_info_id) {
                                                        $("#btn_attribute" + n + " li").eq(s).click(); //如果id相同

                                                    }
                                                }
                                            }
                                        }

                                        //关闭购物车
                                        btnGrayBar.click(function () {
                                            detail.show();
                                            buyPage.hide();
                                            goodsnum=1;
                                            Ponto.invoke(
                                                    "Messaging",
                                                    "refreshable",
                                                    {isfresh:true},
                                                    null,
                                                    null);
                                            Ponto.invoke(
                                                    "Messaging",
                                                    "showBackBtn",
                                                    null,
                                                    null,
                                                    null);

                                        });
                                        //购买加入购物车
                                        var itembtncfim = $('.items-btnConfirm');
                                        itembtncfim.unbind("click");
                                        itembtncfim.bind("click",function () {
                                            if( $('.number').html() <= 0 ) {
                                                Ponto.invoke(
                                                        "Messaging",
                                                        "toast",
                                                        {"title":'请添加购买数量！'},
                                                        null,
                                                        null);
                                                return false;
                                            }
                                            if(deviceid == null){
                                                alert("请从APP端购买！");
                                            }else{
                                                var buynum = eval($(".number").html());
                                                for(var t=0;t<onCarGoodsList.length;t++){
                                                    if( eval($("#goods_buy_small_image").data("goodsid")) == eval(onCarGoodsList[t].goods_info_id)){
                                                        buynum = buynum + eval(onCarGoodsList[t].goods_num);
                                                    }
                                                }
                                                $.ajax({
                                                    type: "POST",
                                                    url: "../goods_interface.php",
                                                    data:{
                                                        "intertype":102,
                                                        "id":buygoosID,
                                                        "deviceid":deviceid,
                                                        "token":GlobalsaveToken,
                                                        "default_goods_info_id":0,
                                                        "goods_info_id":eval($("#goods_buy_small_image").data("goodsid")),
                                                        "goods_number":buynum
                                                    },
                                                    success: function(data){
                                                        if(JSON.parse(data).code == 200){
                                                            //alert(eval($("#goods_buy_small_image").data("goodsid")));
                                                            alert(JSON.parse(data).message);
                                                            detail.show();
                                                            buyPage.hide();
                                                            showtag();
                                                            var tagnum = eval($('.tag-num').html());
                                                            $('.tag-num').html(eval($(".number").html())+tagnum);
                                                            Ponto.invoke(
                                                                    "Messaging",
                                                                    "showBackBtn",
                                                                    null,
                                                                    null,
                                                                    null);
                                                            Ponto.invoke(
                                                                    "Messaging",
                                                                    "addToCart",
                                                                    {},
                                                                    null,
                                                                    null);
                                                        }else {
                                                            alert(JSON.parse(data).message);
                                                            Ponto.invoke(
                                                                    "Messaging",
                                                                    "toast",
                                                                    {"title":JSON.parse(data).message},
                                                                    null,
                                                                    null);
                                                            return false;
                                                        }
                                                    },
                                                    error:function(data){
                                                        alert(JSON.parse(data).message);
                                                        Ponto.invoke(
                                                                "Messaging",
                                                                "toast",
                                                                {"title":JSON.parse(data).message},
                                                                null,
                                                                null);
                                                        return false;
                                                    }
                                                });
                                            }
                                        });
                                    }
                                }
                            }else{
                                //直接添加进购物车post成功后执行+1或2
                                //alert(deviceid);
                                if(deviceid ==null ){
                                    alert("无设备号，请下载APP！");
                                }if(GlobalsaveToken == null){
                                    alert("无token，请登录购买！")
                                    Ponto.invoke(
                                            "Messaging",
                                            "login",
                                            {},
                                            null,
                                            null);
                                }else {
                                    add(eval(obj.cart_number_least));
                                    //alert(buygoosID);
                                    //alert(deviceid);
                                    //alert(GlobalsaveToken);
                                    //alert(goodsnum);
                                    $.ajax({
                                        type: "POST",
                                        url: "../goods_interface.php",
                                        data:{
                                            "intertype":102,
                                            "id":buygoosID,
                                            "deviceid":deviceid,
                                            "token":GlobalsaveToken,
                                            "goods_number":goodsnum
                                        },
                                        success: function(data){
                                            //alert(eval($('.tag-num').html()));
                                            //alert(String(data));//210
                                            //alert(JSON.parse(data).goods_number);
                                            if(JSON.parse(data).code == 200){
                                                $('.tag-num').html(JSON.parse(data).goods_number);
                                                showtag();
                                                $('.tag-num').html(goodsnum);
                                                Ponto.invoke(
                                                        "Messaging",
                                                        "addToCart",
                                                        {},
                                                        null,
                                                        null);
                                            }
                                            else if(JSON.parse(data).code == 202){
                                                //token值不匹配
                                                Ponto.invoke(
                                                        "Messaging",
                                                        "toast",
                                                        {"title":JSON.parse(data).message},
                                                        null,
                                                        null);
                                                Ponto.invoke(
                                                        "Messaging",
                                                        "login",
                                                        {},
                                                        null,
                                                        null);
                                            /*Ponto.invoke(
                                                        "Messaging",
                                                        "getToken",
                                                        {userLogin:true},
                                                        function (token) {
                                                            //$("#token").val(token);
                                                            //GlobalsaveToken = token;
                                                        },
                                                        null);*/
                                            }else{
                                                Ponto.invoke(
                                                        "Messaging",
                                                        "toast",
                                                        {"title":JSON.parse(data).message},
                                                        null,
                                                        null);
                                                return false;
                                            }
                                        },
                                        error: function(){
                                            //请求出错处理
                                            Ponto.invoke(
                                                    "Messaging",
                                                    "toast",
                                                    {"title":'网络断了，请稍后再试'},
                                                    null,
                                                    null);
                                        }
                                    });
                                }
                            }
                            function add(num){
                                goodsnum = goodsnum+ num;
                            }
                            function reduce(num){
                                goodsnum = goodsnum- num;
                                //$('.tag-num').html(goodsnum);
                            }
                            function showtag(){
                                if ($('.buytips').hasClass('fadeInDown')) {
                                    $('.buytips').removeClass('fadeInDown');
                                }
                                $('.buytips').show().addClass('fadeInDown');
                                setTimeout(function () {
                                    $('.buytips').hide().removeClass('fadeInDown');
                                }, 1500);
                                $('.tag-num').show();
                            }
                        });
                    }
                }else { //已下架
                    btncartshop.css({'background':"#ccc",'border': '1px solid #c4c5c6'});
                    btncartshop.html("商品已下架");
                }

            }
            /*end*/

            var detailImage = $('.detail-images');


            var detail = $('#goods-detail');
            var buyPage = $('#buyPageInner');
            var detailSelected = $('.detail-selected');
            var btnGrayBar = $('.btn-grayBar');

            var btncartlist = $('.btn-scar');
            //进入购物车界面OK
            btncartlist.click(function () {
                Ponto.invoke(
                        "Messaging",
                        "goToCart",
                        {},
                        null,
                        null);
            });

            //添加收藏
            var btnCollect = $('.btn-collect');
            btnCollect.unbind("click");
            btnCollect.bind("click",function() {
                if($(this).hasClass('active')){
                    $.ajax({
                        type: "POST",
                        url: "../goods_interface.php",
                        data:{
                            "intertype":103,
                            "id":Val_id,
                            "deviceid":deviceid,
                            "token":GlobalsaveToken
                        },
                        success: function(data){
                            //alert(eval($('.tag-num').html()));
                            if(JSON.parse(data).code == 200){
                                btnCollect.removeClass('active');
                                Ponto.invoke(
                                        "Messaging",
                                        "toast",
                                        {"title":'取消收藏！'},
                                        null,
                                        null);
                                return false;
                            } else if(JSON.parse(data).code == 202){
                                //token值不匹配
                                Ponto.invoke(
                                        "Messaging",
                                        "login",
                                        {},
                                        null,
                                        null);
                            }else{
                                Ponto.invoke(
                                        "Messaging",
                                        "toast",
                                        {"title":JSON.parse(data).message},
                                        null,
                                        null);
                                return false;
                            }
                        }
                    });
                }else{
                    $.ajax({
                        type: "POST",
                        url: "../goods_interface.php",
                        data:{
                            "intertype":103,
                            "id":Val_id,
                            "deviceid":deviceid,
                            "token":GlobalsaveToken
                        },
                        success: function(data){
                            //alert(String(data));
                            if(JSON.parse(data).code == 200){
                                btnCollect.addClass('active');
                                Ponto.invoke(
                                        "Messaging",
                                        "toast",
                                        {"title":'成功添加收藏！'},
                                        null,
                                        null);
                                return false;
                            } else if(JSON.parse(data).code == 202){
                                //token值不匹配
                                Ponto.invoke(
                                        "Messaging",
                                        "login",
                                        {},
                                        null,
                                        null);
                            }else{
                                Ponto.invoke(
                                        "Messaging",
                                        "toast",
                                        {"title":JSON.parse(data).message},
                                        null,
                                        null);
                                return false;
                            }
                        }
                    });
                }
            })

        $(window).scroll(function(){
            var scrollTop = $(this).scrollTop();
            var scrollHeight = $(document).height();
            var windowHeight = $(this).height();
            if(scrollTop + windowHeight >= scrollHeight){
               $(".totop").show();
                $(".totop").click(function(){
                    goTopHovetree(400);
                });
            }else {
                $(".totop").hide();
            }
        });

        function goTopHovetree(times) {
            if (!!!times) {
                $(window).scrollTop(0);
                return;
            }
            var sh = $('body').scrollTop();//移动总距离
            var inter = 13.333;//ms,每次移动间隔时间
            var forCount = Math.ceil(times / inter);//移动次数
            var stepL = Math.ceil(sh / forCount);//移动步长
            var timeId = null;
            function aniHovertree() {
                !!timeId && clearTimeout(timeId);
                timeId = null;
                //console.log($('body').scrollTop());
                if ($('body').scrollTop() <= 0 || forCount <= 0) {//移动端判断次数好些，因为移动端的scroll事件触发不频繁，有可能检测不到有<=0的情况
                    $('body').scrollTop(0);
                    return;
                }
                forCount--;
                sh -= stepL;
                $('body').scrollTop(sh);
                timeId = setTimeout(function () { aniHovertree(); }, inter);
            }
            aniHovertree();
        }
    });

</script>
<script>
    function user_login_res(token) {
        //alert('21');
        //alert(token);
        $("#user_login").val(1);
        GlobalsaveToken=token;
    }
</script>
<!--<script>
    var objItem = {
        "length":6,
        item:[
            {"img":"images/share-itemsPic.png","name":"士民族风民族民族风风民族风坡跟","price":"$100.00","from":"美国直邮","promo":0,"none":1,"from_icon":"images/us.png"},
            {"img":"images/share-itemsPic.png","name":"士民族风民族民族风风民族风坡跟","price":"$200.00","from":"美国直邮","promo":1,"none":0,"from_icon":"images/us.png"},
            {"img":"images/share-itemsPic.png","name":"士民族风民族民族风风民族风坡跟","price":"$200.00","from":"美国直邮","promo":1,"none":0,"from_icon":"images/us.png"},
            {"img":"images/share-itemsPic.png","name":"士民族风民族民族风风民族风坡跟","price":"$300.00","from":"美国直邮","promo":0,"none":1,"from_icon":"images/us.png"},
            {"img":"images/share-itemsPic.png","name":"士民族风民族民族风风民族风坡跟","price":"$300.00","from":"美国直邮","promo":0,"none":1,"from_icon":"images/us.png"},
            {"img":"images/share-itemsPic.png","name":"士民族风民族民族风风民族风坡跟","price":"$300.00","from":"美国直邮","promo":0,"none":1,"from_icon":"images/us.png"}
        ]
    }
    $(window).scroll(function(){
        var scrollTop = $(this).scrollTop();
        var scrollHeight = $(document).height();
        var windowHeight = $(this).height();
        if(scrollTop + windowHeight == scrollHeight){
            /*$("#Adivce-carriage").show();*/
           /* appendcarriage(objItem);*/
            /*$.post("#",
                    { "id": "1822" },
                    function(data){
                        alert(data);
                    },
                    "json");*/
        }
        /*function appendcarriage(obj){
            var lastIndex = $('.list-container .mm-crriage').length;
            if (lastIndex == obj.length) return;
            addItems(obj);
         }*/

    });
    /*function addItems(obj) {
        var html = '';
        for (var i = 0 ; i < obj.item.length; i++) {
            html += '<div class="mm-crriage"><div class="mm-crriage-pic">';
            if(obj.item[i].promo == 1){
                html += '<span class="mm-crriage-promo"></span>';
            }if(obj.item[i].none == 1){
                html += '<span class="mm-crriage-none"></span>';
            }
            html += '<img src="'+obj.item[i].img+'"></div>';

            html += '<p class="mm-crriage-title">'+obj.item[i].name+'</p><p class="mm-crriage-price">'+obj.item[i].price+'</p><p class="mm-crriage-from"><span class="mm-crriage-from-pic" style="background: url(&quot;'+obj.item[i].from_icon+'&quot;) no-repeat top center;background-size: 14px 14px;"></span>'+obj.item[i].from+'</p></div>';
        }
        $('.list-block .list-container').append(html);
    }*/
</script>-->
</body>
</html>